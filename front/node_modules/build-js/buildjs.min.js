var fs=require("fs"),macros={inc:{action:function(b,e,a,d){/^".*"$/.test(b)&&(b=b.slice(1,-1));return a.slice(0,d)+buildFile(b,(e.match(/^.*\//)||["./"])[0])+a.slice(d)},precedence:1,argc:1},def:{action:function(b,e,a,d){return d.replace(RegExp(b,"g"),e)},precedence:2,argc:2}},ignorable="[ \\t\\n\\r]+",skip=function(b){for(;0<b.length&&RegExp(ignorable).test(b[0]);)b.shift()},parseArg=function(b){for(var e="",a={"(":0,"[":0,"{":0};0<b.length&&(!RegExp(ignorable).test(b[0])||0<a["("]||0<a["["]||0<
a["{"]);){var d=b.shift();switch(d){case "(":case "[":case "{":a[d]++;break;case ")":a["("]--;break;case "]":a["["]--;break;case "}":a["{"]--}e+=d}for(var c in a)if(0<a[c])throw Error("Unmatched token '"+c+"'");return e},parse=function(b){for(var b=b.match(/@\w+|".*?"|'.*?'|[\w_$]+|[\s\S]/g),e=[];0<b.length;){var a=b.shift();if("@"===a[0]){var a=a.slice(1),d=macros[a];if(!d)throw Error("Invalid command @"+a);skip(b);for(var c=[];0<b.length&&c.length<d.argc;)c.push(parseArg(b)),skip(b);if(c.length<
d.argc)throw Error("Expected "+d.argc+" argument"+(1<d.argc?"s":"")+" for @"+a+", but only "+c.length+" "+(1<c.length?"were":"was")+" found");e.push({command:d,args:c})}skip(b)}return e},exec=function(b,e,a,d){for(b.sort(function(a,b){return b.command.precedence-a.command.precedence});0<b.length;)var c=b.shift(),a=c.command.action.apply(this,c.args.concat(e,a,d));return a},buildFile=function(b,e){e&&process.chdir(e);if(!fs.existsSync(b))throw Error("File not found '"+b+"'",b);for(var a=fs.readFileSync(b,
"utf-8"),d=/\/\*buildjs[\s\S]*?\*\//g,c;null!==(c=d.exec(a));)try{var g=parse(c[0].slice(9,-2));Array.prototype.splice.call(a,c.index,c[0].length);a=a.slice(0,c.index)+a.slice(c.index+c[0].length);a=exec(g,b,a,c.index)}catch(f){throw a=(a.slice(0,c.index).match(/\n/g)||[]).length,f.caught||(f=Error(f.message,b,a),f.caught=!0,f.fileStack=[],f.lineStack=[]),f.fileStack.push(b),f.lineStack.push(a),f;}return a},build=function(b,e){try{return buildFile(b,e)}catch(a){for(var d="",c=0;c<a.fileStack.length;c++)d+=
"\n    at "+a.fileStack[c]+":"+a.lineStack[c];throw Error(a.message+d,b,a.line);}},toFile=function(b,e,a){if("object"!==typeof b||isNaN(b.length))b=[b];if(!e)throw Error("You must define an output file");a||(a=process.cwd());for(var d="",c=0;c<b.length;c++)d+=build(b[c],a);process.chdir(a);fs.writeFileSync(e,d)};module.exports={version:"1.0.0",build:build,toFile:toFile};
